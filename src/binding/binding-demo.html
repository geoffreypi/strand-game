<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protein-DNA Binding Demo</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a2e;
            color: #ffffff;
            padding: 20px;
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #00ff88; }
        h2 { color: #00ccff; margin-top: 30px; }
        .panel {
            background: #0f0f1e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .molecule-display {
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            overflow-x: auto;
        }
        pre { margin: 0; white-space: pre; }
        input, select {
            font-family: 'Courier New', monospace;
            background: #0f0f1e;
            color: #ffffff;
            border: 1px solid #00ff88;
            padding: 8px;
            border-radius: 4px;
            margin: 5px;
        }
        input[type="text"] { width: 300px; }
        button {
            background: #00ff88;
            color: #0f0f1e;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin: 5px;
        }
        button:hover { background: #00dd77; }
        button.danger { background: #ff4444; }
        button.danger:hover { background: #cc3333; }
        .binding-site { color: #ff88ff; }
        .bound { color: #00ff88; font-weight: bold; }
        .unbound { color: #888888; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .status.success { background: #003300; border: 1px solid #00ff88; }
        .status.info { background: #002244; border: 1px solid #00ccff; }
        .flex-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .flex-col { flex: 1; min-width: 300px; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #333; }
        th { color: #00ccff; }
        .canvas-container {
            background: #000;
            border-radius: 8px;
            margin: 10px 0;
            padding: 10px;
        }
        canvas { display: block; margin: 0 auto; }
        .legend { display: flex; gap: 20px; flex-wrap: wrap; margin: 10px 0; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 20px; height: 20px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Protein-DNA Binding Demo</h1>
        <p style="color: #888;">Version 1.0.3 - Built: 2025-11-22 23:52 UTC</p>
        <p>Visualize how proteins with binding amino acids (BTA, BTC, BTG, BTT) bind to complementary DNA sequences.</p>

        <div class="panel">
            <h2>How It Works</h2>
            <p>Proteins containing <span class="binding-site">BTA</span>, <span class="binding-site">BTC</span>,
               <span class="binding-site">BTG</span>, or <span class="binding-site">BTT</span> amino acids can bind to DNA:</p>
            <div class="legend">
                <div class="legend-item"><span class="binding-site">BTA</span> binds to <strong>A</strong>denine</div>
                <div class="legend-item"><span class="binding-site">BTC</span> binds to <strong>C</strong>ytosine</div>
                <div class="legend-item"><span class="binding-site">BTG</span> binds to <strong>G</strong>uanine</div>
                <div class="legend-item"><span class="binding-site">BTT</span> binds to <strong>T</strong>hymine</div>
            </div>
        </div>

        <div class="flex-row">
            <div class="flex-col">
                <div class="panel">
                    <h2>DNA Molecule</h2>
                    <label>Top Strand (5'->3'):</label>
                    <input type="text" id="dna-sequence" value="AAACGTACGTTTTT" />
                    <button onclick="updateDNA()">Set DNA</button>
                    <div class="molecule-display" id="dna-display"></div>
                </div>
            </div>
            <div class="flex-col">
                <div class="panel">
                    <h2>Add Protein</h2>
                    <label>Amino Acid Sequence:</label>
                    <input type="text" id="protein-sequence" value="STR-BTA-BTC-BTG-BTT-STR" />
                    <button onclick="addProtein()">Add Protein</button>
                    <p style="font-size: 12px; color: #888;">
                        Use: STR, L60, R60, L12, R12, FLX, POS, NEG, PHO, PHI, BTA, BTC, BTG, BTT, CRL, RPF, PBF
                    </p>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>Canvas Visualization</h2>
            <div class="canvas-container">
                <canvas id="bindingCanvas" width="900" height="400"></canvas>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background: #ff6666;"></div> A (Adenine)</div>
                <div class="legend-item"><div class="legend-color" style="background: #66ff66;"></div> C (Cytosine)</div>
                <div class="legend-item"><div class="legend-color" style="background: #6666ff;"></div> G (Guanine)</div>
                <div class="legend-item"><div class="legend-color" style="background: #ffff66;"></div> T (Thymine)</div>
                <div class="legend-item"><div class="legend-color" style="background: #888888;"></div> Non-binding AA</div>
                <div class="legend-item"><div class="legend-color" style="background: #ff88ff;"></div> Binding AA (BT*)</div>
            </div>
        </div>

        <div class="panel">
            <h2>Binding Manager</h2>
            <button onclick="checkBindings()">Check for Bindings</button>
            <button onclick="runSimulation()">Auto-Simulate (1 Hz)</button>
            <button onclick="stopSimulation()" class="danger">Stop</button>
            <div id="binding-status" class="status info">Click "Check for Bindings" to detect protein-DNA matches.</div>
        </div>

        <div class="flex-row">
            <div class="flex-col">
                <div class="panel">
                    <h2>Registered Proteins</h2>
                    <table id="protein-table">
                        <thead><tr><th>ID</th><th>Sequence</th><th>Binding Pattern</th><th>Status</th><th>Action</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="flex-col">
                <div class="panel">
                    <h2>Bound Complexes</h2>
                    <table id="complex-table">
                        <thead><tr><th>Protein</th><th>DNA Position</th><th>Strand</th><th>Strength</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>ASCII Visualization</h2>
            <div class="molecule-display">
                <pre id="ascii-output">Click "Check for Bindings" to see ASCII visualization</pre>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // ASCII Renderer (inline copy)
        // ============================================================================
        class ASCIIRenderer {
            static renderDNA(topSequence, bottomSequence) {
                if (topSequence.length !== bottomSequence.length) {
                    return 'ERROR: Top and bottom sequences must be same length';
                }
                // Hex grid layout with vertical colons for strand spacing
                let topLine = "5'-" + topSequence.split('').map(b => '<' + b + '>').join('-') + "-3'";
                let middleLine = '    ' + topSequence.split('').map(() => ':').join('   ');
                let bottomLine = "3'-" + bottomSequence.split('').map(b => '<' + b + '>').join('-') + "-5'";
                return topLine + '\n' + middleLine + '\n' + middleLine + '\n' + middleLine + '\n' + bottomLine;
            }

            static renderProtein(aminoAcidSequence) {
                return 'N-' + aminoAcidSequence + '-C';
            }
        }

        // ============================================================================
        // Binding helpers
        // ============================================================================
        const AMINO_ACID_BINDING = { BTA: 'A', BTC: 'C', BTG: 'G', BTT: 'T' };

        function getBindingTarget(code) {
            return AMINO_ACID_BINDING[code] || null;
        }

        function extractBindingPattern(protein) {
            const pattern = [];
            for (let i = 0; i < protein.aminoAcids.length; i++) {
                const aa = protein.aminoAcids[i];
                const bindsTo = getBindingTarget(aa.type);
                if (bindsTo) {
                    pattern.push({ position: i, aminoAcid: aa.type, bindsTo: bindsTo, hexPosition: aa.position });
                }
            }
            return pattern;
        }

        function findBindingConfigurations(protein, dna) {
            const bindingPattern = extractBindingPattern(protein);
            if (bindingPattern.length === 0) return [];
            const configurations = [];
            for (const strand of ['top', 'bottom']) {
                const hexes = strand === 'top' ? dna.topHexes : dna.bottomHexes;
                const dnaSequence = hexes.map((hex, i) => ({ position: i, nucleotide: hex.type }));
                for (let dnaStart = 0; dnaStart <= dnaSequence.length - bindingPattern.length; dnaStart++) {
                    let isMatch = true;
                    for (let i = 0; i < bindingPattern.length; i++) {
                        const nucleotide = dnaSequence[dnaStart + i].nucleotide;
                        const bindTarget = bindingPattern[i].bindsTo;
                        if (bindTarget !== nucleotide && !(bindTarget === 'T' && nucleotide === 'U')) {
                            isMatch = false;
                            break;
                        }
                    }
                    if (isMatch) {
                        configurations.push({ strand, dnaStartIndex: dnaStart, bindingStrength: bindingPattern.length });
                    }
                }
            }
            return configurations;
        }

        // ============================================================================
        // Binding Manager
        // ============================================================================
        class BindingManager {
            constructor() {
                this.proteins = new Map();
                this.dnas = new Map();
                this.boundComplexes = [];
                this.nextId = 1;
            }
            addProtein(protein) {
                const id = this.nextId++;
                this.proteins.set(id, { id, protein, boundTo: null });
                return id;
            }
            addDNA(dna) {
                const id = this.nextId++;
                this.dnas.set(id, { id, dna, boundProteins: [] });
                return id;
            }
            removeProtein(id) {
                const entry = this.proteins.get(id);
                if (entry && entry.boundTo) this.unbind(id);
                this.proteins.delete(id);
            }
            checkForBindings() {
                const newBindings = [];
                for (const [proteinId, proteinEntry] of this.proteins) {
                    if (proteinEntry.boundTo) continue;
                    for (const [dnaId, dnaEntry] of this.dnas) {
                        const configs = findBindingConfigurations(proteinEntry.protein, dnaEntry.dna);
                        if (configs.length > 0) {
                            const bestConfig = configs.reduce((a, b) => a.bindingStrength > b.bindingStrength ? a : b);
                            this.boundComplexes.push({ protein: proteinEntry.protein, dna: dnaEntry.dna, configuration: bestConfig, proteinId, dnaId });
                            proteinEntry.boundTo = dnaId;
                            dnaEntry.boundProteins.push(proteinId);
                            newBindings.push({ proteinId, dnaId, configuration: bestConfig });
                            break;
                        }
                    }
                }
                return newBindings;
            }
            unbind(proteinId) {
                const proteinEntry = this.proteins.get(proteinId);
                if (!proteinEntry || !proteinEntry.boundTo) return false;
                const dnaEntry = this.dnas.get(proteinEntry.boundTo);
                if (dnaEntry) dnaEntry.boundProteins = dnaEntry.boundProteins.filter(id => id !== proteinId);
                this.boundComplexes = this.boundComplexes.filter(c => c.proteinId !== proteinId);
                proteinEntry.boundTo = null;
                return true;
            }
            getBoundComplexes() { return [...this.boundComplexes]; }
            isProteinBound(proteinId) {
                const entry = this.proteins.get(proteinId);
                return entry ? entry.boundTo !== null : false;
            }
        }

        // ============================================================================
        // Demo State
        // ============================================================================
        let manager = new BindingManager();
        let currentDNA = null;
        let dnaId = null;
        let simulationInterval = null;

        // ============================================================================
        // Helper Functions
        // ============================================================================
        function createProtein(sequenceStr) {
            const types = sequenceStr.split('-');
            const aminoAcids = types.map((type, i) => ({
                type: type.toUpperCase(),
                position: { q: i, r: 0 }
            }));
            return { aminoAcids, sequenceStr };
        }

        function createDNA(topSequence) {
            const complement = { 'A': 'T', 'T': 'A', 'C': 'G', 'G': 'C' };
            const topHexes = topSequence.split('').map((type, i) => ({ type, q: i, r: 0 }));
            const bottomHexes = topSequence.split('').map((type, i) => ({
                type: complement[type] || 'N', q: i, r: 1
            }));
            return { topHexes, bottomHexes, topSequence };
        }

        function getBindingPatternStr(protein) {
            const pattern = extractBindingPattern(protein);
            if (pattern.length === 0) return '-';
            return pattern.map(p => p.bindsTo).join('');
        }

        // ============================================================================
        // UI Update Functions
        // ============================================================================
        function updateDNA() {
            const seq = document.getElementById('dna-sequence').value.toUpperCase();
            currentDNA = createDNA(seq);

            const oldProteins = [...manager.proteins.values()];
            manager = new BindingManager();
            dnaId = manager.addDNA(currentDNA);

            for (const entry of oldProteins) {
                manager.addProtein(entry.protein);
            }

            updateDNADisplay();
            updateProteinTable();
            updateComplexTable();
            render();
        }

        function escapeHtml(text) {
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function updateDNADisplay() {
            const display = document.getElementById('dna-display');
            if (!currentDNA) {
                display.innerHTML = '<pre>No DNA set</pre>';
                return;
            }
            const top = currentDNA.topSequence;
            const bottom = currentDNA.bottomHexes.map(h => h.type).join('');
            const dnaAscii = ASCIIRenderer.renderDNA(top, bottom);
            display.innerHTML = '<pre>' + escapeHtml(dnaAscii) + '</pre>';
        }

        function addProtein() {
            const seq = document.getElementById('protein-sequence').value;
            const protein = createProtein(seq);
            if (!currentDNA) updateDNA();
            manager.addProtein(protein);
            updateProteinTable();
            render();
        }

        function removeProtein(id) {
            manager.removeProtein(id);
            updateProteinTable();
            updateComplexTable();
            render();
        }

        function updateProteinTable() {
            const tbody = document.querySelector('#protein-table tbody');
            tbody.innerHTML = '';
            for (const [id, entry] of manager.proteins) {
                const pattern = getBindingPatternStr(entry.protein);
                const isBound = manager.isProteinBound(id);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${id}</td>
                    <td style="font-size: 11px;">${entry.protein.sequenceStr}</td>
                    <td class="binding-site">${pattern}</td>
                    <td class="${isBound ? 'bound' : 'unbound'}">${isBound ? 'BOUND' : 'Unbound'}</td>
                    <td><button onclick="removeProtein(${id})" class="danger" style="padding: 4px 8px; font-size: 11px;">Remove</button></td>
                `;
                tbody.appendChild(tr);
            }
        }

        function updateComplexTable() {
            const tbody = document.querySelector('#complex-table tbody');
            tbody.innerHTML = '';
            for (const complex of manager.getBoundComplexes()) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${complex.proteinId}</td>
                    <td>${complex.configuration.dnaStartIndex}</td>
                    <td>${complex.configuration.strand}</td>
                    <td>${complex.configuration.bindingStrength}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        function checkBindings() {
            const newBindings = manager.checkForBindings();
            const status = document.getElementById('binding-status');
            if (newBindings.length > 0) {
                status.className = 'status success';
                status.textContent = 'Created ' + newBindings.length + ' new binding(s)!';
            } else {
                status.className = 'status info';
                status.textContent = 'No new bindings found. Proteins may already be bound or no matching sequences.';
            }
            updateProteinTable();
            updateComplexTable();
            updateASCIIDisplay();
            render();
        }

        function updateASCIIDisplay() {
            const output = document.getElementById('ascii-output');
            if (!currentDNA) {
                output.textContent = 'No DNA set';
                return;
            }

            let lines = [];
            const complexes = manager.getBoundComplexes();
            const topComplexes = complexes.filter(c => c.configuration.strand === 'top');
            const bottomComplexes = complexes.filter(c => c.configuration.strand === 'bottom');
            const top = currentDNA.topSequence;
            const bottom = currentDNA.bottomHexes.map(h => h.type).join('');

            // Proteins bound to top strand
            for (const complex of topComplexes) {
                const startPos = complex.configuration.dnaStartIndex;
                const indent = '   ' + '    '.repeat(startPos);
                const proteinAscii = ASCIIRenderer.renderProtein(complex.protein.sequenceStr);
                lines.push(indent + proteinAscii + ' (Protein #' + complex.proteinId + ')');
                const pattern = extractBindingPattern(complex.protein);
                lines.push(indent + pattern.map(() => ' | ').join(' '));
            }

            // DNA
            lines.push(ASCIIRenderer.renderDNA(top, bottom));

            // Proteins bound to bottom strand
            for (const complex of bottomComplexes) {
                const startPos = complex.configuration.dnaStartIndex;
                const indent = '   ' + '    '.repeat(startPos);
                const pattern = extractBindingPattern(complex.protein);
                lines.push(indent + pattern.map(() => ' | ').join(' '));
                const proteinAscii = ASCIIRenderer.renderProtein(complex.protein.sequenceStr);
                lines.push(indent + proteinAscii + ' (Protein #' + complex.proteinId + ')');
            }

            output.textContent = lines.join('\n');
        }

        // ============================================================================
        // Canvas Rendering
        // ============================================================================
        const NUCLEOTIDE_COLORS = { 'A': '#ff6666', 'C': '#66ff66', 'G': '#6666ff', 'T': '#ffff66', 'U': '#ffaa66' };
        const AA_COLORS = {
            BTA: '#ff88ff', BTC: '#ff88ff', BTG: '#ff88ff', BTT: '#ff88ff',
            STR: '#888888', L60: '#888888', R60: '#888888', L12: '#888888', R12: '#888888', FLX: '#888888',
            POS: '#ff4444', NEG: '#4444ff', PHO: '#aa8844', PHI: '#44aaaa',
            CRL: '#ff8800', RPF: '#88ff88', PBF: '#8888ff'
        };

        function render() {
            const canvas = document.getElementById('bindingCanvas');
            const ctx = canvas.getContext('2d');

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (!currentDNA) return;

            const hexSize = 25;
            const startX = 50;
            const dnaY = canvas.height / 2;

            // DNA backbone
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(startX, dnaY - 20);
            ctx.lineTo(startX + currentDNA.topSequence.length * hexSize * 1.5, dnaY - 20);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(startX, dnaY + 20);
            ctx.lineTo(startX + currentDNA.topSequence.length * hexSize * 1.5, dnaY + 20);
            ctx.stroke();

            // DNA nucleotides
            for (let i = 0; i < currentDNA.topHexes.length; i++) {
                const x = startX + i * hexSize * 1.5;

                // Top strand
                const topNuc = currentDNA.topHexes[i].type;
                ctx.fillStyle = NUCLEOTIDE_COLORS[topNuc] || '#ffffff';
                ctx.beginPath();
                ctx.arc(x, dnaY - 20, hexSize / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#000';
                ctx.font = '12px monospace';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(topNuc, x, dnaY - 20);

                // Bottom strand
                const bottomNuc = currentDNA.bottomHexes[i].type;
                ctx.fillStyle = NUCLEOTIDE_COLORS[bottomNuc] || '#ffffff';
                ctx.beginPath();
                ctx.arc(x, dnaY + 20, hexSize / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#000';
                ctx.fillText(bottomNuc, x, dnaY + 20);

                // Vertical spacing between strands (hex grid style)
                ctx.fillStyle = '#666';
                for (let dot = 0; dot < 3; dot++) {
                    const dotY = dnaY - 6 + dot * 6;
                    ctx.beginPath();
                    ctx.arc(x, dotY, 1.5, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // Bound proteins
            const complexes = manager.getBoundComplexes();
            for (const complex of complexes) {
                const startPos = complex.configuration.dnaStartIndex;
                const strand = complex.configuration.strand;
                const pattern = extractBindingPattern(complex.protein);
                const proteinY = strand === 'top' ? dnaY - 70 : dnaY + 70;

                for (let i = 0; i < complex.protein.aminoAcids.length; i++) {
                    const aa = complex.protein.aminoAcids[i];
                    const isBinding = pattern.some(p => p.position === i);

                    let x;
                    if (isBinding) {
                        const bindingIdx = pattern.findIndex(p => p.position === i);
                        x = startX + (startPos + bindingIdx) * hexSize * 1.5;
                    } else {
                        const firstBindingPos = pattern.length > 0 ? pattern[0].position : 0;
                        const offset = i - firstBindingPos;
                        x = startX + startPos * hexSize * 1.5 + offset * hexSize * 1.2;
                    }

                    ctx.fillStyle = AA_COLORS[aa.type] || '#888888';
                    ctx.beginPath();
                    ctx.arc(x, proteinY, hexSize / 2 - 2, 0, Math.PI * 2);
                    ctx.fill();

                    if (isBinding) {
                        ctx.strokeStyle = '#00ff88';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([4, 2]);
                        ctx.beginPath();
                        ctx.moveTo(x, proteinY + (strand === 'top' ? hexSize / 2 : -hexSize / 2));
                        ctx.lineTo(x, dnaY + (strand === 'top' ? -30 : 30));
                        ctx.stroke();
                        ctx.setLineDash([]);
                    }

                    ctx.fillStyle = '#000';
                    ctx.font = '9px monospace';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(aa.type, x, proteinY);
                }

                ctx.fillStyle = '#fff';
                ctx.font = '11px monospace';
                const labelX = startX + startPos * hexSize * 1.5 - 30;
                ctx.fillText('#' + complex.proteinId, labelX, proteinY);
            }

            // Unbound proteins
            let unboundY = 350;
            for (const [id, entry] of manager.proteins) {
                if (!manager.isProteinBound(id)) {
                    ctx.fillStyle = '#333';
                    ctx.fillRect(30, unboundY - 15, 200, 30);
                    ctx.fillStyle = '#888';
                    ctx.font = '11px monospace';
                    ctx.textAlign = 'left';
                    ctx.fillText('#' + id + ': ' + entry.protein.sequenceStr.substring(0, 20) + '...', 35, unboundY);
                    unboundY += 35;
                }
            }
        }

        // ============================================================================
        // Simulation
        // ============================================================================
        function runSimulation() {
            if (simulationInterval) return;
            simulationInterval = setInterval(() => { checkBindings(); }, 1000);
            document.getElementById('binding-status').textContent = 'Simulation running (1 Hz)...';
            document.getElementById('binding-status').className = 'status info';
        }

        function stopSimulation() {
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
                document.getElementById('binding-status').textContent = 'Simulation stopped.';
            }
        }

        // ============================================================================
        // Initialize
        // ============================================================================
        updateDNA();

        const examples = ['STR-BTA-BTC-BTG-BTT-STR', 'BTA-BTA-BTA', 'L60-BTG-BTC-R60'];
        for (const seq of examples) {
            const protein = createProtein(seq);
            manager.addProtein(protein);
        }
        updateProteinTable();
        render();

        console.log('Demo initialized successfully!');
    </script>
</body>
</html>
